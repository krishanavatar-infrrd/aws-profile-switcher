"""
AWS Environment Management
"""

import configparser
from pathlib import Path
from typing import Dict, Optional

from aws_profile_manager.core.config import ConfigManager, get_region_display_name
from aws_profile_manager.utils.logging import LoggerMixin


class EnvironmentManager(LoggerMixin):
    """Manages AWS environments and environment switching"""
    
    def __init__(self, config_manager: ConfigManager):
        self.config_manager = config_manager
        self.config_path = Path.home() / '.aws' / 'config'
    
    def switch_environment(self, env_name: str) -> bool:
        """Switch to a specific environment"""
        self.logger.info(f"Switching to {env_name.upper()} environment")
        
        environments = self.config_manager.get_environments()
        if env_name not in environments:
            self.logger.error(f"Environment {env_name} not found in configuration")
            return False
        
        env_config = environments[env_name]
        
        try:
            # Create .aws directory if it doesn't exist
            self.config_path.parent.mkdir(parents=True, exist_ok=True)
            
            # Read existing config
            config = configparser.ConfigParser()
            if self.config_path.exists():
                config.read(self.config_path)
            
            # Create or update environment profile
            profile_section = f'profile {env_name}'
            if not config.has_section(profile_section):
                config.add_section(profile_section)
            
            config.set(profile_section, 'region', env_config['region'])
            config.set(profile_section, 'role_arn', env_config['role_arn'])
            config.set(profile_section, 'source_profile', 'default')
            
            # Write to file
            with open(self.config_path, 'w') as f:
                config.write(f)
            
            self.logger.info(f"Switched to {env_name.upper()} environment")
            return True
            
        except Exception as e:
            self.logger.error(f"Failed to switch environment: {e}")
            return False
    
    def list_environments(self) -> Dict[str, Dict[str, str]]:
        """List all available environments"""
        environments = self.config_manager.get_environments()
        result = {}
        
        for env_name, env_config in environments.items():
            region_display = get_region_display_name(env_config['region'])
            result[env_name] = {
                'region': env_config['region'],
                'region_display': region_display,
                'role_arn': env_config['role_arn'],
                'description': env_config.get('description', '')
            }
        
        return result
    
    def get_current_environment(self) -> Optional[str]:
        """Get current environment from AWS_PROFILE"""
        import os
        current_profile = os.environ.get('AWS_PROFILE', 'default')
        
        # Check if current profile is an environment
        environments = self.config_manager.get_environments()
        if current_profile in environments:
            return current_profile
        
        return None
    
    def add_environment(self, env_name: str, region: str, role_arn: str, description: str = '') -> bool:
        """Add a new environment"""
        try:
            environments = self.config_manager.get_environments()
            environments[env_name] = {
                'region': region,
                'role_arn': role_arn,
                'description': description
            }
            
            self.config_manager.set('environments', environments)
            return self.config_manager.save_config()
            
        except Exception as e:
            self.logger.error(f"Failed to add environment: {e}")
            return False
    
    def update_environment(self, env_name: str, region: str = None, role_arn: str = None, description: str = None) -> bool:
        """Update an existing environment"""
        try:
            environments = self.config_manager.get_environments()
            
            if env_name not in environments:
                self.logger.error(f"Environment {env_name} not found")
                return False
            
            if region is not None:
                environments[env_name]['region'] = region
            if role_arn is not None:
                environments[env_name]['role_arn'] = role_arn
            if description is not None:
                environments[env_name]['description'] = description
            
            self.config_manager.set('environments', environments)
            return self.config_manager.save_config()
            
        except Exception as e:
            self.logger.error(f"Failed to update environment: {e}")
            return False
    
    def remove_environment(self, env_name: str) -> bool:
        """Remove an environment"""
        try:
            environments = self.config_manager.get_environments()
            
            if env_name in environments:
                del environments[env_name]
                self.config_manager.set('environments', environments)
                return self.config_manager.save_config()
            
            return True
            
        except Exception as e:
            self.logger.error(f"Failed to remove environment: {e}")
            return False
